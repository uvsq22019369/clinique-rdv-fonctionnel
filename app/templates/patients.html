{% extends "base.html" %}

{% block title %}{{ _('Liste des patients') }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-people"></i> {{ _('Patients') }}</h2>
    </div>
    <div class="col text-end">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-download"></i> {{ _('Exporter') }}
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{{ url_for('admin.export_patients_csv') }}">CSV</a></li>
                <li><a class="dropdown-item" href="{{ url_for('admin.export_patients_excel') }}">Excel</a></li>
            </ul>
        </div>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#ajouterPatientModal">
            <i class="bi bi-person-plus"></i> {{ _('Nouveau patient') }}
        </button>
    </div>
</div>

<!-- Filtres et recherche -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" id="searchInput" class="form-control" placeholder="{{ _('Rechercher par nom ou téléphone...') }}">
        </div>
    </div>
    <div class="col-md-3">
        <select id="perPageSelect" class="form-select">
            <option value="10">10 {{ _('par page') }}</option>
            <option value="25">25 {{ _('par page') }}</option>
            <option value="50">50 {{ _('par page') }}</option>
            <option value="100">100 {{ _('par page') }}</option>
        </select>
    </div>
</div>

<!-- Liste des patients -->
<div class="card">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="bi bi-people"></i> {{ _('Tous les patients') }}</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped" id="patientsTable">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="nom">{{ _('Nom') }} <i class="bi bi-arrow-down-up"></i></th>
                        <th class="sortable" data-sort="telephone">{{ _('Téléphone') }} <i class="bi bi-arrow-down-up"></i></th>
                        <th>{{ _('Email') }}</th>
                        <th class="sortable" data-sort="date">{{ _('Date naissance') }} <i class="bi bi-arrow-down-up"></i></th>
                        <th class="sortable" data-sort="created">{{ _('Inscription') }} <i class="bi bi-arrow-down-up"></i></th>
                        <th>{{ _('Actions') }}</th>
                    </tr>
                </thead>
                <tbody id="patientsTableBody"></tbody>
            </table>
        </div>
        
        <nav aria-label="{{ _('Navigation des pages') }}">
            <ul class="pagination justify-content-center" id="pagination"></ul>
        </nav>
    </div>
</div>

<!-- Modal Ajouter Patient -->
<div class="modal fade" id="ajouterPatientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-person-plus"></i> {{ _('Nouveau patient') }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('appointments.ajouter_patient') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nom" class="form-label">{{ _('Nom complet') }}</label>
                        <input type="text" class="form-control" id="nom" name="nom" required>
                    </div>
                    <div class="mb-3">
                        <label for="telephone" class="form-label">{{ _('Téléphone') }}</label>
                        <input type="tel" class="form-control" id="telephone" name="telephone" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">{{ _('Email (optionnel)') }}</label>
                        <input type="email" class="form-control" id="email" name="email">
                    </div>
                    <div class="mb-3">
                        <label for="date_naissance" class="form-label">{{ _('Date de naissance (optionnel)') }}</label>
                        <input type="date" class="form-control" id="date_naissance" name="date_naissance">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Annuler') }}</button>
                    <button type="submit" class="btn btn-success">{{ _('Ajouter') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let currentSort = 'nom';
let currentSortDir = 'asc';
let currentSearch = '';
let currentPerPage = 10;

function loadPatients() {
    const url = new URL('{{ url_for("appointments.api_patients") }}', window.location.origin);
    url.searchParams.append('page', currentPage);
    url.searchParams.append('per_page', currentPerPage);
    url.searchParams.append('sort', currentSort);
    url.searchParams.append('dir', currentSortDir);
    url.searchParams.append('search', currentSearch);
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            displayPatients(data.patients);
            setupPagination(data.total, data.pages);
        });
}

function displayPatients(patients) {
    const tbody = document.getElementById('patientsTableBody');
    tbody.innerHTML = '';
    
    patients.forEach(p => {
        const row = `
            <tr>
                <td>${p.nom}</td>
                <td>${p.telephone}</td>
                <td>${p.email || '-'}</td>
                <td>${p.date_naissance || '-'}</td>
                <td>${p.date_creation}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="voirPatient(${p.id})">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function setupPagination(total, pages) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    pagination.innerHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">{{ _('Précédent') }}</a>
        </li>
    `;
    
    for (let i = 1; i <= pages; i++) {
        if (i === 1 || i === pages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            pagination.innerHTML += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                </li>
            `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            pagination.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    pagination.innerHTML += `
        <li class="page-item ${currentPage === pages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">{{ _('Suivant') }}</a>
        </li>
    `;
}

function changePage(page) {
    if (page < 1) return;
    currentPage = page;
    loadPatients();
}

document.getElementById('searchInput').addEventListener('input', function(e) {
    currentSearch = e.target.value;
    currentPage = 1;
    loadPatients();
});

document.getElementById('perPageSelect').addEventListener('change', function(e) {
    currentPerPage = parseInt(e.target.value);
    currentPage = 1;
    loadPatients();
});

document.querySelectorAll('.sortable').forEach(th => {
    th.addEventListener('click', function() {
        const sort = this.dataset.sort;
        if (currentSort === sort) {
            currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort = sort;
            currentSortDir = 'asc';
        }
        loadPatients();
    });
});

loadPatients();
</script>
{% endblock %}