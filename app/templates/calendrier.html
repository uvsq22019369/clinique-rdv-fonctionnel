{% extends "base.html" %}

{% block title %}{{ _('Calendrier des rendez-vous') }}{% endblock %}

{% block styles %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<style>
    #calendar {
        max-width: 1100px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }
    .fc-toolbar-title {
        font-size: 1.5rem !important;
        font-weight: 600 !important;
        color: #2d2d2d;
    }
    .fc-button-primary {
        background-color: #4e73df !important;
        border-color: #4e73df !important;
    }
    .fc-button-primary:hover {
        background-color: #224abe !important;
    }
    .fc-day-today {
        background-color: rgba(78, 115, 223, 0.05) !important;
    }
    .fc-event {
        border-radius: 8px !important;
        padding: 2px 5px !important;
        font-size: 0.85rem !important;
        border: none !important;
    }
    .filter-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.03);
        border-left: 4px solid #4e73df;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-calendar-week"></i> {{ _('Calendrier des rendez-vous') }}</h2>
        </div>
        <div class="col text-end">
            <a href="{{ url_for('appointments.prendre_rdv') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> {{ _('Nouveau RDV') }}
            </a>
        </div>
    </div>

    <!-- Filtres -->
    <div class="filter-card">
        <div class="row">
            <div class="col-md-4">
                <label class="form-label">{{ _('Médecin') }}</label>
                <select id="medecinFilter" class="form-select">
                    <option value="all">{{ _('Tous les médecins') }}</option>
                    {% for m in medecins %}
                    <option value="{{ m.id }}">Dr. {{ m.prenom }} {{ m.nom }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">{{ _('Statut') }}</label>
                <select id="statutFilter" class="form-select">
                    <option value="all">{{ _('Tous les statuts') }}</option>
                    <option value="confirme">{{ _('Confirmé') }}</option>
                    <option value="termine">{{ _('Terminé') }}</option>
                    <option value="annule">{{ _('Annulé') }}</option>
                    <option value="absent">{{ _('Absent') }}</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Calendrier -->
    <div id="calendar"></div>
</div>
{% endblock %}

{% block scripts %}
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/fr.js'></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',  // Vue semaine avec créneaux horaires
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        locale: 'fr',  // Pour avoir les jours en français
        slotMinTime: '08:00:00',
        slotMaxTime: '20:00:00',
        allDaySlot: false,
        height: 'auto',
        events: function(info, successCallback, failureCallback) {
            // Charger les événements via l'API
            const url = new URL('{{ url_for("appointments.api_rendez_vous") }}', window.location.origin);
            url.searchParams.append('start', info.startStr);
            url.searchParams.append('end', info.endStr);
            
            const medecinFilter = document.getElementById('medecinFilter').value;
            if (medecinFilter !== 'all') {
                url.searchParams.append('medecin', medecinFilter);
            }
            
            const statutFilter = document.getElementById('statutFilter').value;
            if (statutFilter !== 'all') {
                url.searchParams.append('statut', statutFilter);
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Transformer les données en événements FullCalendar
                    const events = data.map(rdv => {
                        // Couleur selon le statut
                        let color = '#3788d8';  // Bleu par défaut
                        if (rdv.statut === 'termine') color = '#1cc88a';  // Vert
                        if (rdv.statut === 'annule') color = '#e74a3b';   // Rouge
                        if (rdv.statut === 'absent') color = '#f6c23e';   // Orange
                        
                        return {
                            id: rdv.id,
                            title: `${rdv.patient_nom} (Dr. ${rdv.medecin_nom})`,
                            start: `${rdv.date}T${rdv.heure}`,
                            end: `${rdv.date}T${rdv.fin || rdv.heure}`,
                            backgroundColor: color,
                            borderColor: color,
                            extendedProps: {
                                patient: rdv.patient_nom,
                                medecin: rdv.medecin_nom,
                                telephone: rdv.patient_tel,
                                motif: rdv.motif,
                                statut: rdv.statut
                            }
                        };
                    });
                    successCallback(events);
                })
                .catch(error => {
                    console.error('Erreur chargement rendez-vous:', error);
                    failureCallback(error);
                });
        },
        eventClick: function(info) {
            // Afficher les détails du rendez-vous
            const rdv = info.event.extendedProps;
            alert(`
Patient: ${rdv.patient}
Médecin: ${rdv.medecin}
Téléphone: ${rdv.telephone || 'Non renseigné'}
Motif: ${rdv.motif || 'Non spécifié'}
Statut: ${rdv.statut}
            `);
        }
    });
    
    calendar.render();
    
    // Recharger le calendrier quand les filtres changent
    document.getElementById('medecinFilter').addEventListener('change', function() {
        calendar.refetchEvents();
    });
    
    document.getElementById('statutFilter').addEventListener('change', function() {
        calendar.refetchEvents();
    });
});
</script>
{% endblock %}